name: ğŸ§ª CI/CD Pipeline - Kaleem Frontend

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # ØªØ´ØºÙŠÙ„ ÙŠÙˆÙ…ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ø³Ø§Ø¹Ø© 2 ØµØ¨Ø§Ø­Ø§Ù‹
    - cron: '0 2 * * *'

env:
  NODE_VERSION: '20'
  NPM_CACHE: '~/.npm'

jobs:
  # ğŸ” ÙØ­Øµ Ø¬ÙˆØ¯Ø© Ø§Ù„ÙƒÙˆØ¯
  lint-and-format:
    name: ğŸ” ÙØ­Øµ Ø¬ÙˆØ¯Ø© Ø§Ù„ÙƒÙˆØ¯
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Ø¥Ø¹Ø¯Ø§Ø¯ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
        run: npm ci
        
      - name: ğŸ” ÙØ­Øµ ESLint
        run: npm run lint
        
      - name: ğŸ¨ ÙØ­Øµ Prettier
        run: npm run format:check
        
      - name: ğŸ”’ ÙØ­Øµ Ø§Ù„Ø£Ù…Ø§Ù†
        run: npm audit --audit-level=moderate

  # ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø©
  unit-tests:
    name: ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø©
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 20, 21]
    steps:
      - name: ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Ø¥Ø¹Ø¯Ø§Ø¯ Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          
      - name: ğŸ“¦ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
        run: npm ci
        
      - name: ğŸ§ª ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
        run: npm test -- --reporter=verbose --run
        
      - name: ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡
        run: npm run test:performance
        
      - name: ğŸ’¾ Ø­ÙØ¸ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø£Ø¯Ø§Ø¡
        uses: actions/upload-artifact@v4
        with:
          name: test-performance-${{ matrix.node-version }}
          path: test-performance/
          retention-days: 30

  # ğŸ“Š ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØªØºØ·ÙŠØ©
  coverage:
    name: ğŸ“Š ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØªØºØ·ÙŠØ©
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - name: ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Ø¥Ø¹Ø¯Ø§Ø¯ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
        run: npm ci
        
      - name: ğŸ§ª ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù…Ø¹ Ø§Ù„ØªØºØ·ÙŠØ©
        run: npm run test:coverage
        
      - name: ğŸ“Š Ø±ÙØ¹ Ø§Ù„ØªØºØ·ÙŠØ© Ø¥Ù„Ù‰ Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          
      - name: ğŸ“ˆ Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØºØ·ÙŠØ©
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const coverage = JSON.parse(fs.readFileSync('./coverage/coverage-summary.json', 'utf8'));
            
            const summary = `## ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØºØ·ÙŠØ©
            
            **Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØºØ·ÙŠØ©:** ${coverage.total.lines.pct}%
            
            ### ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØºØ·ÙŠØ©:
            - **Lines:** ${coverage.total.lines.pct}% (${coverage.total.lines.covered}/${coverage.total.lines.total})
            - **Statements:** ${coverage.total.statements.pct}% (${coverage.total.statements.covered}/${coverage.total.statements.total})
            - **Functions:** ${coverage.total.functions.pct}% (${coverage.total.functions.covered}/${coverage.total.functions.total})
            - **Branches:** ${coverage.total.branches.pct}% (${coverage.total.branches.covered}/${coverage.total.branches.total})
            
            ### Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø£Ù‚Ù„ ØªØºØ·ÙŠØ©:
            ${Object.entries(coverage)
              .filter(([key]) => key !== 'total')
              .sort((a, b) => a[1].lines.pct - b[1].lines.pct)
              .slice(0, 5)
              .map(([file, data]) => `- **${file}:** ${data.lines.pct}%`)
              .join('\n')}
            `;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

  # ğŸš€ Ø§Ù„Ù†Ø´Ø± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
  deploy:
    name: ğŸš€ Ø§Ù„Ù†Ø´Ø± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
    runs-on: ubuntu-latest
    needs: [lint-and-format, unit-tests, coverage]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    steps:
      - name: ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Ø¥Ø¹Ø¯Ø§Ø¯ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
        run: npm ci
        
      - name: ğŸ§ª ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
        run: npm test -- --run
        
      - name: ğŸ—ï¸ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
        run: npm run build
        
      - name: ğŸ“Š Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ø´Ø±
        run: |
          echo "## ğŸš€ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ø´Ø± - $(date)" >> deploy-report.md
          echo "**Branch:** ${{ github.ref_name }}" >> deploy-report.md
          echo "**Commit:** ${{ github.sha }}" >> deploy-report.md
          echo "**Author:** ${{ github.actor }}" >> deploy-report.md
          echo "**Build Time:** $(date)" >> deploy-report.md
          echo "" >> deploy-report.md
          echo "### âœ… Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©:" >> deploy-report.md
          echo "- ÙØ­Øµ Ø¬ÙˆØ¯Ø© Ø§Ù„ÙƒÙˆØ¯" >> deploy-report.md
          echo "- Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø©" >> deploy-report.md
          echo "- ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØªØºØ·ÙŠØ©" >> deploy-report.md
          echo "- Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹" >> deploy-report.md
          
      - name: ğŸ’¾ Ø­ÙØ¸ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ø´Ø±
        uses: actions/upload-artifact@v4
        with:
          name: deploy-report
          path: deploy-report.md
          retention-days: 90

  # ğŸ“‹ Ù…Ù„Ø®Øµ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
  summary:
    name: ğŸ“‹ Ù…Ù„Ø®Øµ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    runs-on: ubuntu-latest
    needs: [lint-and-format, unit-tests, coverage]
    if: always()
    steps:
      - name: ğŸ“Š Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ø®Øµ
        uses: actions/github-script@v7
        with:
          script: |
            const { lint, tests, coverage } = context.job;
            
            const summary = `## ğŸ“‹ Ù…Ù„Ø®Øµ CI/CD Pipeline
            
            ### ğŸ” ÙØ­Øµ Ø¬ÙˆØ¯Ø© Ø§Ù„ÙƒÙˆØ¯: ${lint.conclusion === 'success' ? 'âœ… Ù†Ø¬Ø­' : 'âŒ ÙØ´Ù„'}
            ### ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø©: ${tests.conclusion === 'success' ? 'âœ… Ù†Ø¬Ø­Øª' : 'âŒ ÙØ´Ù„Øª'}
            ### ğŸ“Š ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØªØºØ·ÙŠØ©: ${coverage.conclusion === 'success' ? 'âœ… Ù†Ø¬Ø­Øª' : 'âŒ ÙØ´Ù„Øª'}
            
            **Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:** ${Math.round((Date.now() - new Date(context.payload.head_commit.timestamp).getTime()) / 1000)}s
            
            ---
            *ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨ÙˆØ§Ø³Ø·Ø© GitHub Actions* ğŸ¤–
            `;
            
            if (context.eventName === 'pull_request') {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: summary
              });
            }
